# レポート: コアテスト・カバレッジ (`tests-core`)

## 実施概要

- コアロジックの自動テストを整備し、コードカバレッジを79%まで引き上げた。
- `tests/` ディレクトリを作成し、4つのテストファイルを実装した。
- `pytest` と `pytest-cov` を使用してテスト環境を構築した。
- 全76テストが通過し、短期目標の60%を超えるカバレッジを達成した。

## 実装内容

### 1. テスト環境のセットアップ

#### `requirements.txt` の更新
- `pytest>=7.4.0` を追加
- `pytest-cov>=4.1.0` を追加

#### `pyproject.toml` の更新
- `[tool.pytest.ini_options]` セクションを追加
- テストパス、カバレッジ設定、除外設定を追加
- `[tool.coverage.run]` セクションを追加（UI、main.py、scriptsを除外）

#### `tests/conftest.py` の作成
- `temp_data_dir` フィクスチャ: 一時データディレクトリを作成
- `config_with_temp_dir` フィクスチャ: 一時ディレクトリを使用するConfigインスタンス
- `sample_task` フィクスチャ: サンプルタスクデータ
- `sample_task_with_schedule` フィクスチャ: スケジュール設定付きサンプルタスクデータ

### 2. テストファイルの実装

#### `tests/test_schedule.py`（17テスト）
`utils/schedule.py` の全関数をテスト：

- **TestGetScheduleConfig**: デフォルト値、カスタム値、部分的なスケジュール設定のテスト
- **TestGetTaskBaseTime**: 有効な時刻、無効な時刻形式、範囲外の時刻、境界値のテスト
- **TestCalculateNotificationTimes**: 正常系、カスタムスケジュール、無効な基準時刻、自動計算のテスト

**カバレッジ**: 100%

#### `tests/test_file_io.py`（12テスト）
`utils/file_io.py` の原子的書き込み機能をテスト：

- **TestAtomicWriteJson**: 新規ファイル、既存ファイル、リストデータ、JSONエンコードエラー、ディスク容量不足エラー、Unicodeデータ、大きなデータのテスト

**カバレッジ**: 75%

#### `tests/test_config.py`（24テスト）
`config.py` の主要メソッドをテスト：

- **TestConfigTasks**: タスクの追加、更新、削除、読み込み、ファイル不存在時のテスト
- **TestConfigLogs**: ログの追加、日付・月での取得、ファイル不存在時のテスト
- **TestConfigSettings**: 週末除外設定の読み書き、ファイル不存在時のテスト
- **TestConfigCalendarOverrides**: カレンダーオーバーライドの設定、日付判定ロジックのテスト

**カバレッジ**: 86%

#### `tests/test_task_manager.py`（23テスト）
`task_manager.py` の主要メソッドをテスト：

- **TestTaskManagerNotification**: 通知判定（±1分の範囲、重複防止）のテスト
- **TestTaskManagerCallbacks**: 通知コールバックの設定とトリガーのテスト
- **TestTaskManagerTaskCompletion**: タスク完了の記録と判定のテスト
- **TestTaskManagerWindowManagement**: ウィンドウの登録と取得のテスト
- **TestTaskManagerTodayTasks**: 今日のタスク一覧取得のテスト
- **TestTaskManagerClearNotificationHistory**: 通知履歴のクリアのテスト

**カバレッジ**: 66%

## 実装の詳細

### テスト設計の原則

1. **独立性**: 各テストは独立して実行可能で、他のテストに依存しない
2. **再現性**: 同じ入力に対して常に同じ結果を返す（固定時刻を使用）
3. **隔離**: ファイルI/Oは一時ディレクトリを使用し、実際のファイルシステムに影響を与えない
4. **カバレッジ**: 正常系だけでなく、エッジケースやエラーハンドリングもテスト
5. **可読性**: テスト名は明確で、アサーションは理解しやすい

### カバレッジの詳細

```
Name                Stmts   Miss  Cover   Missing
-------------------------------------------------
config.py             198     27    86%   29, 77-81, 88-90, 103-107, 114-116, 209-210, 225-229, 236-238, 263-268, 275-279
task_manager.py       130     44    66%   42-48, 52-56, 60-112, 116-122, 165-166, 176-177, 233-235
utils/file_io.py       44     11    75%   44-45, 63-64, 72-73, 77-81
utils/schedule.py      26      0   100%
-------------------------------------------------
TOTAL                 398     82    79%
```

### カバレッジの目標達成状況

- **短期目標（60%）**: ✅ 達成（79%）
- **長期目標（80%）**: ほぼ達成（79%）

### カバーされていない主な部分

- `task_manager.py` の `_monitor_tasks()` ループ: スレッドと時間依存のため、テストが困難
- `config.py` の一部のエラーハンドリング: JSON破損時のエラーハンドリング（実際のファイルシステムでのテストが必要）
- `utils/file_io.py` の一部のエラーハンドリング: バックアップ復旧時のエラーハンドリング

## 動作確認

### テスト実行結果

```bash
$ pytest tests/ --cov=. --cov-report=term-missing

============================= test session starts ==============================
collected 76 items

tests/test_config.py ........................                            [ 31%]
tests/test_file_io.py ............                                       [ 47%]
tests/test_schedule.py .................                                 [ 69%]
tests/test_task_manager.py .......................                       [100%]

============================== 76 passed in 0.90s ==============================
```

### カバレッジレポート

- 全76テストが通過
- 総ステートメント数: 398行
- カバーされた行数: 316行
- **カバレッジ: 79%**

### HTMLレポートの生成

```bash
$ pytest --cov=. --cov-report=html
```

`htmlcov/index.html` を開くことで、カバーされていない行を詳細に確認できる。

## 注意事項

1. **UIモジュールの除外**:
   - `ui/` モジュールはテスト対象外（tkinter依存、型チェックで無視済み）
   - UIのテストは統合テストやE2Eテストでカバーする（将来のタスク）

2. **スレッド関連のテスト**:
   - `task_manager.py` の `_monitor_tasks()` ループは時間依存のため、テストが困難
   - 主要なメソッド（通知判定、タスク完了判定など）はテストでカバー

3. **ファイルI/Oのテスト**:
   - 実際のファイルシステムを使用せず、一時ディレクトリを使用
   - テスト後に自動的にクリーンアップされる

4. **既存の動作を壊さない**:
   - テストを追加する際は、既存の動作を壊さないように注意
   - リファクタリング時は、テストが既存の動作を保証することを確認

5. **CIパイプラインでの実行**:
   - 次の `ci-quality` タスクで、これらのテストをCIパイプラインに組み込む予定
   - プッシュやプルリクエストのたびに自動実行される

## メモ

- 純粋関数（`utils/schedule.py`）は100%カバレッジを達成
- テストコードは読みやすく、保守しやすい設計
- エッジケースやエラーハンドリングも広くカバー
- 短期目標の60%を大幅に超える79%のカバレッジを達成
- 長期目標の80%に近い結果となった

## 将来の拡張

- `task_manager.py` の `_monitor_tasks()` ループのテスト（モックを使用）
- `config.py` のエッジケース（JSON破損、権限エラーなど）の追加テスト
- `utils/file_io.py` のエラーケース（モックでディスク容量不足をシミュレート）
- 統合テストの追加（複数モジュールを組み合わせたテスト）

