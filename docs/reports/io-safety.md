# レポート: 原子的書き込み・バックアップ/復旧 (`io-safety`)

## 実施概要

- 設定ファイルとタスクファイルの書き込み処理を原子的書き込みに変更し、データ破損のリスクを低減した。
- `utils/file_io.py` に汎用的な原子的書き込み関数 `atomic_write_json()` を実装した。
- `config.py` の4つの `_save_*` メソッドを原子的書き込みに変更し、既存のインターフェースを維持した。

## 実装内容

### 1. 原子的書き込み関数の実装（`utils/file_io.py`）

新規ファイル `utils/file_io.py` を作成し、以下の機能を実装：

- **一時ファイルへの書き込み**: `.tmp` ファイルにデータを書き込み
- **原子的リネーム**: `os.replace()` を使用して一時ファイルを元のファイル名にリネーム
- **バックアップ作成**: 既存ファイルがある場合は `.bak` バックアップを作成
- **自動復旧**: エラー発生時にバックアップから自動復旧を試みる
- **ログ出力**: DEBUG/INFO/WARNING/ERROR レベルで詳細なログを出力

### 2. `config.py` の更新

以下の4つの `_save_*` メソッドを原子的書き込みに変更：

- `_save_tasks()`: タスクデータの保存
- `_save_logs()`: ログデータの保存
- `_save_settings()`: 設定データの保存
- `_save_calendar_overrides()`: カレンダーオーバーライドデータの保存

**変更内容**:
- `open()` + `json.dump()` のパターンを `atomic_write_json()` に置き換え
- 既存のインターフェース（メソッド名・引数・戻り値）は維持
- 呼び出し側のコード変更は不要

### 3. 動作確認

- アプリケーション起動時の動作確認を実施
- タスク追加・編集・削除時のファイル書き込みを確認
- ログファイル（`app.log`）に `utils.file_io` からのログが正常に出力されることを確認
- 一時ファイル（`.tmp`）やバックアップファイル（`.bak`）が正常終了時に削除されることを確認

## 実装の特徴

### 後方互換性
- 既存のJSONファイルはそのまま使用可能
- ファイル形式や構造は変更しない
- 既存のAPIインターフェースは維持

### データ保護
- 書き込み失敗時も既存ファイルが破損しない
- エラー時にバックアップから自動復旧を試みる
- 詳細なログ出力でデバッグとトラブルシューティングを支援

### パフォーマンス
- 原子的書き込みは通常の書き込みより若干オーバーヘッドがあるが、実用的な範囲内
- バックアップ作成は既存ファイルがある場合のみ実行される

## ログ出力例

```
2025-11-18 14:03:19,179 - utils.file_io - INFO - ファイルを原子的に書き込みました: data\tasks.json
2025-11-18 14:03:19,179 - config - INFO - タスクデータを保存しました: 5件
```

DEBUG レベルのログ（バックアップ作成、一時ファイル書き込み開始など）を確認する場合は、`main.py` のログレベルを `DEBUG` に変更可能。

## メモ

- `.tmp` ファイルは正常終了時に自動削除される
- `.bak` ファイルは書き込み成功時に自動削除される
- エラー時のみこれらのファイルが残る可能性がある
- `.gitignore` で `data/` ディレクトリ全体が除外されているため、`.bak` と `.tmp` ファイルも自動的に除外される
- ログレベルを `DEBUG` に設定すると、より詳細な情報が得られる
