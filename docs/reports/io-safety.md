# レポート: 原子的書き込み・ロック・バックアップ/復旧 (`io-safety`)

## 実施概要
- 設定ファイルやタスクファイルの読み書き処理を見直し、原子的書き込みとバックアップ/復旧機能を導入した。
- `utils/file_io.py` に原子的書き込み関数 `atomic_write_json()` を実装した。
- `config.py` の4つの `_save_*` メソッドを原子的書き込みに変更した。

## 実装内容

### 1. 原子的書き込み関数の実装（`utils/file_io.py`）

新規ファイル `utils/file_io.py` を作成し、以下の機能を実装した：
- **一時ファイルへの書き込み**: `.tmp` ファイルにデータを書き込み
- **原子的リネーム**: `os.replace()` で一時ファイルを元のファイルに置き換え
- **バックアップ作成**: 既存ファイルがある場合、書き込み前に `.bak` バックアップを作成
- **エラーハンドリング**: 書き込み失敗時にバックアップから復旧を試みる
- **ログ出力**: DEBUG/INFO/WARNING/ERROR レベルでログを出力

### 2. `config.py` の更新

以下の4つの `_save_*` メソッドを原子的書き込みに変更した：
- `_save_tasks()`: タスクデータの保存
- `_save_logs()`: ログデータの保存
- `_save_settings()`: 設定データの保存
- `_save_calendar_overrides()`: カレンダーオーバーライドデータの保存

**変更内容**:
- `open()` + `json.dump()` のパターンを `atomic_write_json()` に置き換え
- 既存のインターフェースは維持（メソッド名や引数は変更なし）
- 内部実装のみを原子的書き込みに変更

### 3. ログ出力の確認

- プロジェクト全体のログ出力を確認し、`utils.file_io` からのログが適切に出力されることを確認した。
- タスクファイルやログファイルの書き込み時に `utils.file_io` からのログが記録されることを確認した。
- 一時ファイル（`.tmp`）やバックアップファイル（`.bak`）が正常に処理されることを確認した。

## 実装の詳細

### 処理フロー
- 既存ファイルがある場合は、書き込み前にバックアップ（`.bak`）を作成
- 一時ファイル（`.tmp`）にデータを書き込み
- 書き込み成功後、`os.replace()` で原子的にリネーム
- 成功したらバックアップを削除
- エラー時は一時ファイルを削除し、バックアップから復旧を試みる

### エラーハンドリング
- 書き込み失敗時は既存ファイルが壊れない
- バックアップからの自動復旧機能
- 詳細なログ出力でトラブルシューティングを支援

## ログ出力例
```
2025-11-18 14:03:19,179 - utils.file_io - INFO - ファイルを原子的に書き込みました: data\tasks.json
2025-11-18 14:03:19,179 - config - INFO - タスクデータを保存しました: 5件
```

DEBUG レベルのログ（バックアップ作成、一時ファイル書き込み、バックアップ削除など）も適切に出力される。詳細なデバッグ情報が必要な場合は、`main.py` のログレベルを `DEBUG` に変更する。

## 注意事項

- `.tmp` ファイルは正常終了時には自動削除される
- `.bak` ファイルは書き込み成功時に自動削除される
- エラー時のみこれらのファイルが残る可能性がある
- `.gitignore` で `data/` ディレクトリ全体が無視されているが、`.bak` と `.tmp` ファイルも無視される
- ログレベルを `DEBUG` に変更すると、より詳細な情報が得られる
