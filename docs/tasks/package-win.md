# package-win: Windows配布タスク仕様

- **目的**: Windows向けの配布パッケージを作成し、ユーザーが簡単にインストール・利用できる状態にする。
- **関連ID**: `package-win`
- **依存タスク**: `ci-quality`（CI品質ゲートが通過している必要がある）

## 1. 要件定義

### 1.1 機能要件

#### 必須要件
1. **単一実行ファイル（exe）の生成**
   - PyInstallerを使用して、Python環境なしで動作する単一exeファイルを生成
   - ユーザーはexeファイルをダブルクリックするだけで起動可能
   - 依存関係（matplotlib等）をすべてバンドル

2. **データディレクトリの自動作成**
   - 実行時に`data/`ディレクトリを自動作成
   - 初期設定ファイル（tasks.json、logs.json等）を自動作成
   - ユーザーの作業ディレクトリに依存しない動作

3. **ログファイルの出力**
   - `app.log`をexeと同じディレクトリに出力
   - ログファイルのパスを適切に設定

4. **起動速度の最適化**
   - 起動時間を5秒以内に抑える（目標）
   - 不要なモジュールの除外

#### 推奨要件
1. **アイコンの設定**
   - アプリケーション用のアイコンファイル（.ico）を作成
   - exeファイルにアイコンを埋め込み

2. **バージョン情報の埋め込み**
   - exeファイルにバージョン情報を埋め込み
   - Windowsのプロパティで確認可能にする

### 1.2 非機能要件

1. **互換性**
   - Windows 10以降で動作
   - 32bit/64bit両対応（または64bitのみ）
   - 管理者権限不要

2. **ファイルサイズ**
   - 単一exeファイルのサイズを100MB以下に抑える（目標）
   - 必要に応じてUPX圧縮を検討

3. **パフォーマンス**
   - 起動時間: 5秒以内
   - メモリ使用量: 適切な範囲内

4. **セキュリティ**
   - ウイルススキャンで誤検知されないよう配慮
   - コード署名（将来的な拡張）

## 2. 技術的な実装方針

### 2.1 使用ツール

#### PyInstaller
- **バージョン**: 最新版（6.x系推奨）
- **理由**:
  - Pythonアプリケーションのパッケージングで最も一般的
  - 単一exeファイルの生成が可能
  - Windows/macOS/Linux対応
  - アクティブにメンテナンスされている

#### その他のツール（オプション）
- **UPX**: exeファイルの圧縮（サイズ削減）
- **Inno Setup / NSIS**: インストーラ作成（将来の拡張）

### 2.2 ビルド方式

#### 方式1: 単一exeファイル（onefile）
- **メリット**: 配布が簡単、1ファイルのみ
- **デメリット**: 起動がやや遅い、一時ファイルを展開

#### 方式2: ディレクトリ配布（onedir）
- **メリット**: 起動が速い
- **デメリット**: 複数ファイルの配布が必要

**推奨**: 方式1（onefile）を採用。ユーザビリティを優先。

### 2.3 除外するモジュール

以下のモジュールは不要なので除外：
- `pytest`（テスト用）
- `pytest-cov`（テスト用）
- `ruff`（開発用）
- `black`（開発用）
- `mypy`（開発用）
- `mcp_setup/`（開発用）

### 2.4 含める必要があるリソース

- Python標準ライブラリ（tkinter、json等）
- `matplotlib`（グラフ表示用）
- アプリケーションコード（`main.py`、`config.py`、`task_manager.py`、`ui/`、`utils/`）

## 3. 実装手順

### 3.1 準備

1. **PyInstallerのインストール**
   ```bash
   pip install pyinstaller
   ```

2. **requirements.txtの更新**
   - PyInstallerを開発依存として追加（または別ファイルに分離）

3. **アイコンファイルの準備（オプション）**
   - `assets/icon.ico`を作成
   - または既存のアイコンを使用

### 3.2 PyInstaller設定ファイル（.spec）の作成

`main.spec`を作成し、以下を設定：

- **エントリーポイント**: `main.py`
- **onefileモード**: 有効
- **コンソールウィンドウ**: 非表示（GUIアプリ）
- **アイコン**: `assets/icon.ico`（存在する場合）
- **除外モジュール**: 開発用モジュール
- **追加データ**: 必要に応じて

### 3.3 ビルドスクリプトの作成

#### Windows用（PowerShell）
`scripts/build-windows.ps1`を作成：
- PyInstallerの実行
- ビルド結果の確認
- エラーハンドリング

#### ローカルテスト用
`scripts/build-local.ps1`を作成：
- 開発環境でのビルドテスト

### 3.4 GitHub Actionsでの自動ビルド

`.github/workflows/build-release.yml`を作成：

1. **トリガー**:
   - `push`（タグが`v*`の場合）
   - `workflow_dispatch`（手動実行）

2. **ジョブ**:
   - Windows環境のセットアップ
   - 依存関係のインストール
   - PyInstallerでのビルド
   - 成果物のアップロード
   - GitHub Releasesへの自動アップロード（タグの場合）

### 3.5 テスト

1. **ローカルビルドテスト**
   - 開発環境でビルド
   - exeファイルの起動確認
   - 基本機能の動作確認

2. **クリーン環境でのテスト**
   - Python未インストールのWindows環境でテスト
   - すべての機能が正常に動作することを確認

3. **自動テスト（CI）**
   - GitHub Actionsでのビルド成功確認

## 4. 配布方法

### 4.1 GitHub Releases

1. **リリースの作成**
   - GitHub上でリリースを作成
   - タグ（例: `v1.0.0`）を付与
   - リリースノートを記載

2. **成果物のアップロード**
   - exeファイルをアップロード
   - チェックサム（SHA256）を記載
   - 使用方法を記載

3. **自動化**
   - GitHub Actionsで自動アップロード

### 4.2 リリースノートの内容

- バージョン情報
- 変更内容
- 使用方法
- システム要件
- トラブルシューティング

## 5. ドキュメント要件

### 5.1 README.mdの更新

以下のセクションを追加/更新：

1. **Windows版のダウンロード方法**
   - GitHub Releasesへのリンク
   - ダウンロード手順

2. **インストール手順**
   - exeファイルのダウンロード
   - 起動方法
   - 初回起動時の注意事項

3. **トラブルシューティング**
   - よくある問題と解決方法
   - ウイルススキャンの誤検知について

### 5.2 CHANGELOG.mdの作成

- バージョンごとの変更履歴
- 新機能、バグ修正、既知の問題

### 5.3 ビルド手順のドキュメント

- 開発者向けのビルド手順
- トラブルシューティング

## 6. 注意事項

### 6.1 ウイルススキャンの誤検知

- PyInstallerで生成したexeは誤検知されやすい
- 対策:
  - コード署名（将来的）
  - ウイルススキャンサービスへの提出
  - ユーザーへの説明

### 6.2 データディレクトリの場所

- 実行ファイルと同じディレクトリに`data/`を作成
- または、ユーザーのホームディレクトリに作成
- 現在の実装（同じディレクトリ）を維持

### 6.3 ログファイルの場所

- 実行ファイルと同じディレクトリに`app.log`を出力
- 現在の実装を維持

### 6.4 起動速度

- onefileモードは起動時に一時ファイルを展開するため、やや遅い
- 必要に応じてonedirモードを検討

### 6.5 ファイルサイズ

- matplotlibを含むため、ファイルサイズが大きくなる可能性
- 必要に応じてUPX圧縮を検討

## 7. 実装チェックリスト

### 準備
- [ ] PyInstallerをインストール
- [ ] requirements.txtを更新（PyInstallerを追加）
- [ ] アイコンファイルを準備（オプション）

### 設定ファイル
- [ ] `main.spec`を作成
- [ ] 除外モジュールを設定
- [ ] アイコンを設定（存在する場合）
- [ ] バージョン情報を設定（オプション）

### ビルドスクリプト
- [ ] `scripts/build-windows.ps1`を作成
- [ ] `scripts/build-local.ps1`を作成（オプション）
- [ ] エラーハンドリングを実装

### CI/CD
- [ ] `.github/workflows/build-release.yml`を作成
- [ ] 自動ビルドを設定
- [ ] GitHub Releasesへの自動アップロードを設定

### テスト
- [ ] ローカルでビルドテスト
- [ ] exeファイルの起動確認
- [ ] 基本機能の動作確認
- [ ] クリーン環境でのテスト
- [ ] CIでの自動ビルドテスト

### ドキュメント
- [ ] README.mdを更新
- [ ] CHANGELOG.mdを作成
- [ ] ビルド手順をドキュメント化

### リリース
- [ ] 初回リリースを作成
- [ ] リリースノートを記載
- [ ] チェックサムを記載

## 8. 参考リソース

- [PyInstaller公式ドキュメント](https://pyinstaller.org/)
- [PyInstaller GitHub](https://github.com/pyinstaller/pyinstaller)
- [GitHub Actions公式ドキュメント](https://docs.github.com/actions)
- [GitHub Releases API](https://docs.github.com/rest/releases/releases)

## 9. 実装メモ（AIエージェント向け）

### 重要なポイント

1. **データディレクトリのパス**
   - `sys.executable`を使用してexeファイルのディレクトリを取得
   - または`os.path.dirname(sys.executable)`を使用

2. **ログファイルのパス**
   - exeファイルと同じディレクトリに出力
   - `os.path.join(os.path.dirname(sys.executable), "app.log")`

3. **一時ファイルの処理**
   - onefileモードでは一時ディレクトリに展開される
   - `sys._MEIPASS`で一時ディレクトリのパスを取得可能

4. **matplotlibのバックエンド**
   - tkinterバックエンドを使用（GUIアプリ）
   - 設定を確認

5. **エラーハンドリング**
   - ビルドエラー時の適切なエラーメッセージ
   - ユーザーフレンドリーなエラーメッセージ

### トラブルシューティング

- **ImportError**: 必要なモジュールが除外されている可能性
- **FileNotFoundError**: データディレクトリのパスが間違っている可能性
- **起動が遅い**: onefileモードの特性、または不要なモジュールが含まれている可能性
