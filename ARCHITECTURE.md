# TaskReminder アーキテクチャドキュメント

## 概要

TaskReminderは、発達障害のある方向けの定型業務サポートツールです。タスクのリマインダー機能と達成率管理機能を提供するデスクトップアプリケーションです。

## システムアーキテクチャ

### 全体構成

```
┌─────────────────────────────────────────────────────────┐
│                    TaskReminder                          │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐      ┌──────────────┐                │
│  │  main.py     │──────│ TaskManager  │                │
│  │ (Entry Point)│      │ (Scheduler)  │                │
│  └──────┬───────┘      └──────┬───────┘                │
│         │                      │                         │
│         │                      │                         │
│  ┌──────▼───────┐      ┌──────▼───────┐                │
│  │ UI Layer     │      │ Config        │                │
│  │ - MainWindow │      │ (Data I/O)    │                │
│  │ - Reminder   │      └──────┬───────┘                │
│  │ - Settings   │             │                         │
│  │ - LogWindow  │      ┌──────▼───────┐                │
│  └──────────────┘      │ utils/        │                │
│                        │ - file_io     │                │
│                        │ - schedule    │                │
│                        └──────┬───────┘                │
│                               │                         │
│                        ┌──────▼───────┐                │
│                        │ data/        │                │
│                        │ - tasks.json │                │
│                        │ - logs.json  │                │
│                        │ - settings   │                │
│                        └──────────────┘                │
└─────────────────────────────────────────────────────────┘
```

## モジュール構成

### 1. エントリーポイント

#### `main.py`
- **役割**: アプリケーションのエントリーポイント
- **責務**:
  - ロギング設定の初期化
  - TaskManagerのインスタンス化
  - UIコンポーネントの初期化と起動
  - exe環境と開発環境の両方に対応したログファイルパスの設定

### 2. コアモジュール

#### `task_manager.py`
- **役割**: タスク管理とスケジューリングの中核
- **責務**:
  - タスクの時刻監視（バックグラウンドスレッド）
  - 通知タイミングの計算とトリガー
  - 通知コールバックの管理
  - アクティブな通知の追跡
- **主要メソッド**:
  - `start_monitoring()`: 監視スレッドの開始
  - `stop_monitoring()`: 監視スレッドの停止
  - `_monitor_tasks()`: メイン監視ループ
  - `_trigger_pre_notification()`: 予告通知のトリガー
  - `_trigger_main_notification()`: 本通知のトリガー
  - `_trigger_warning_notification()`: 警告通知のトリガー

#### `config.py`
- **役割**: 設定管理とデータI/O
- **責務**:
  - JSONファイルの読み書き
  - タスクデータの管理（追加・更新・削除）
  - ログデータの管理
  - 設定データの管理（週末除外設定など）
  - カレンダーオーバーライドの管理
  - exe環境と開発環境の両方に対応したベースディレクトリの取得
- **主要メソッド**:
  - `load_tasks()`: タスクデータの読み込み
  - `save_tasks()`: タスクデータの保存
  - `add_task()`: タスクの追加
  - `update_task()`: タスクの更新
  - `delete_task()`: タスクの削除
  - `load_logs()`: ログデータの読み込み
  - `save_logs()`: ログデータの保存
  - `is_date_included()`: 達成率計算対象日の判定

### 3. UIモジュール (`ui/`)

#### `main_window.py`
- **役割**: メインウィンドウ（タスクバー常駐）
- **責務**:
  - アプリケーションのメインウィンドウ表示
  - 設定画面・ログ画面へのアクセス提供
  - ウィンドウの最小化・閉じる処理

#### `reminder_window.py`
- **役割**: リマインダー通知ウィンドウ
- **責務**:
  - 予告通知の表示
  - 本通知の表示（チェックボックス付き）
  - 警告通知の表示
  - タスク完了の記録

#### `settings_window.py`
- **役割**: タスク設定画面
- **責務**:
  - タスクの追加・編集・削除UI
  - タスクの有効/無効切り替え
  - タスク一覧の表示

#### `log_window.py`
- **役割**: ログ・達成率表示画面
- **責務**:
  - 月ごとの達成率表示
  - 過去12ヶ月の未達成率グラフ表示
  - 週末除外設定のUI
  - カレンダーオーバーライドのUI

### 4. ユーティリティモジュール (`utils/`)

#### `file_io.py`
- **役割**: 原子的ファイルI/O
- **責務**:
  - JSONファイルの原子的書き込み
  - バックアップ/復旧機能
  - データ整合性の保証
- **主要関数**:
  - `atomic_write_json()`: JSONファイルを原子的に書き込む

#### `schedule.py`
- **役割**: スケジュール計算ユーティリティ
- **責務**:
  - 通知タイミングの計算（純粋関数）
  - タスクの基準時刻の計算
  - スケジュール設定の取得
- **主要関数**:
  - `get_task_base_time()`: タスクの基準時刻を計算
  - `calculate_notification_times()`: 通知タイミングを計算
  - `get_schedule_config()`: スケジュール設定を取得

## データフロー

### 1. アプリケーション起動フロー

```
main.py
  ├─ ロギング設定の初期化
  ├─ TaskManagerのインスタンス化
  ├─ Configの初期化（データディレクトリの作成）
  ├─ MainWindowの作成
  ├─ TaskManagerの監視開始
  └─ Tkinterメインループ開始
```

### 2. タスク監視フロー

```
TaskManager._monitor_tasks() [バックグラウンドスレッド]
  │
  ├─ 現在時刻の取得
  ├─ タスクデータの読み込み（Config.load_tasks()）
  │
  ├─ 各タスクに対して:
  │   ├─ タスクの基準時刻を計算（utils/schedule.py）
  │   ├─ 通知タイミングを計算（utils/schedule.py）
  │   │
  │   ├─ 予告通知タイミングの場合:
  │   │   └─ _trigger_pre_notification()
  │   │       └─ UIコールバック呼び出し
  │   │
  │   ├─ 本通知タイミングの場合:
  │   │   └─ _trigger_main_notification()
  │   │       └─ UIコールバック呼び出し
  │   │
  │   └─ 警告通知タイミングの場合（未完了時）:
  │       └─ _trigger_warning_notification()
  │           └─ UIコールバック呼び出し
  │
  └─ 1秒待機してループ継続
```

### 3. タスク追加フロー

```
SettingsWindow
  ├─ ユーザー入力（時刻、タスク名）
  ├─ Config.add_task()
  │   ├─ タスクデータの読み込み
  │   ├─ 新しいタスクの追加
  │   └─ 原子的書き込み（utils/file_io.py）
  └─ UI更新
```

### 4. タスク完了フロー

```
ReminderWindow
  ├─ ユーザーがチェックボックスをすべてチェック
  ├─ 「完了」ボタンクリック
  ├─ Config.add_log()
  │   ├─ ログデータの読み込み
  │   ├─ ログエントリの追加
  │   └─ 原子的書き込み（utils/file_io.py）
  └─ ウィンドウを閉じる
```

### 5. 達成率計算フロー

```
LogWindow
  ├─ 月の選択
  ├─ Config.get_logs_by_month()
  ├─ Config.is_date_included() [各日付に対して]
  │   ├─ カレンダーオーバーライドの確認
  │   └─ 週末除外設定の確認
  ├─ 達成率の計算
  └─ グラフの表示（matplotlib）
```

## データ構造

### タスクデータ (`tasks.json`)

```json
{
  "tasks": [
    {
      "id": "task_001",
      "time": "14:30",
      "task_names": ["日報", "勤怠報告"],
      "enabled": true,
      "created_date": "2025-11-20",
      "schedule": {
        "pre_notification_minutes": 5,
        "warning_minutes": 5,
        "snooze_minutes": 5
      }
    }
  ]
}
```

### ログデータ (`logs.json`)

```json
{
  "logs": [
    {
      "date": "2025-11-20",
      "time": "14:35",
      "task_id": "task_001",
      "task_name": "日報",
      "completed": true
    }
  ]
}
```

### 設定データ (`settings.json`)

```json
{
  "exclude_weekends": false
}
```

### カレンダーオーバーライド (`calendar_overrides.json`)

```json
{
  "2025-11": {
    "2025-11-23": true,
    "2025-11-24": false
  }
}
```

## 技術スタック

### 言語・ランタイム
- **Python**: 3.13（推奨）、3.7以上（最小要件）

### GUIフレームワーク
- **tkinter**: Python標準ライブラリ、GUIコンポーネント

### データ可視化
- **matplotlib**: 達成率グラフの表示

### パッケージング
- **PyInstaller**: Windows版exeファイルの生成

### 開発ツール
- **ruff**: リントチェック
- **black**: コードフォーマット
- **mypy**: 型チェック
- **pytest**: テスト実行

### CI/CD
- **GitHub Actions**: 自動テスト・ビルド・リリース

## セキュリティ・信頼性

### 原子的書き込み
- `utils/file_io.py`の`atomic_write_json()`関数により、JSONファイルの書き込みが原子的に行われます
- 一時ファイル（`.tmp`）への書き込み → 原子的リネーム（`os.replace()`）の順で処理
- エラー時はバックアップ（`.bak`）から自動復旧を試みます

### バックアップ/復旧
- ファイル書き込み前に自動的にバックアップを作成
- 書き込み成功後、バックアップを削除
- エラー時は一時ファイルを削除し、バックアップから復旧を試みる

### エラーハンドリング
- すべてのファイルI/O操作で例外処理を実装
- ロギングによりエラーを記録
- ユーザーへの適切なエラーメッセージ表示

### データ整合性
- JSONファイルの読み込み時にJSON形式エラーを検出
- エラー時は空のデータを返し、アプリケーションの継続動作を保証

## 実行環境

### 開発環境
- プロジェクトルートに`data/`ディレクトリが作成される
- `app.log`がプロジェクトルートに出力される

### exe環境（Windows版）
- exeファイルと同じディレクトリに`data/`ディレクトリが作成される
- `app.log`がexeファイルと同じディレクトリに出力される
- `sys.frozen`フラグでexe環境を検出

## スレッドモデル

### メインスレッド
- Tkinterのメインループ
- UIイベントの処理
- ユーザーインタラクションの処理

### バックグラウンドスレッド
- `TaskManager._monitor_tasks()`: タスク監視ループ
- 1秒ごとに時刻をチェック
- 通知タイミングの判定とトリガー

### スレッドセーフティ
- UI操作はメインスレッドで実行
- バックグラウンドスレッドからUIを更新する場合は、Tkinterの`after()`メソッドを使用

## テスト戦略

### テストカバレッジ
- 目標: 60%以上（現在: 79%）
- カバレッジツール: pytest-cov

### テスト対象
- `utils/file_io.py`: 原子的書き込みのテスト
- `utils/schedule.py`: スケジュール計算のテスト
- `config.py`: 設定管理のテスト
- `task_manager.py`: タスク管理のテスト

### CI/CD
- GitHub Actionsで自動テスト実行
- プルリクエスト時に自動実行
- カバレッジ閾値チェック（60%以上）

## 今後の拡張予定

### 未実装機能（Stretch Goals）
- スケジュールUI: スケジュールを確認・編集できるUI
- 通知ディスパッチ: 各種通知を集約・ディスパッチする仕組み
- Win/Mac表示差異吸収: Windows/macOSの表示差異を吸収
- macOS配布: macOS向けの配布パッケージ
- MCP自動化: MCPを使った自動化フロー
- デモGIF作成: 主要なユースケースを示すデモGIF
- アーキ図/通知シーケンス図: アーキテクチャ図と通知シーケンス図

## 参考資料

- [README.md](README.md): ユーザー向けドキュメント
- [CHANGELOG.md](CHANGELOG.md): 変更履歴
- [docs/tasks/](docs/tasks/): タスク仕様書
- [docs/reports/](docs/reports/): 実装レポート

